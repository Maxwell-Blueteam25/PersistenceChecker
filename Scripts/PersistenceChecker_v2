function Run-PersistenceCheck {
    param (
        [Parameter(Mandatory)]
        [string]$LogPath
    )

    $log = @()
    $log += "==== Windows Persistence Mechanism Check ===="

    # 1. Registry Run Keys
    $log += "`n[+] Checking Registry Run Keys..."
    $runKeys = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
    )

    foreach ($key in $runKeys) {
        if (Test-Path $key) {
            Get-ItemProperty -Path $key | ForEach-Object {
                $_.PSObject.Properties | Where-Object {
                    $_.Name -notin @("PSPath", "PSParentPath", "PSChildName", "PSDrive", "PSProvider")
                } | ForEach-Object {
                    $log += "$($key)\$($_.Name) -> $($_.Value)"
                }
            }
        }
    }

    # 2. Startup Folder
    $log += "`n[+] Checking Startup Folder Shortcuts..."
    $startupPaths = @(
        "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup",
        "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
    )

    foreach ($path in $startupPaths) {
        if (Test-Path $path) {
            Get-ChildItem -Path $path -Filter *.lnk | ForEach-Object {
                $log += "Startup Shortcut: $($_.FullName)"
            }
        }
    }

    # 3. Scheduled Tasks
    $log += "`n[+] Checking Scheduled Tasks..."
    Get-ScheduledTask | Where-Object { $_.TaskPath -notlike "\Microsoft*" } | ForEach-Object {
        $log += "Task: $($_.TaskName) | Path: $($_.TaskPath)"
    }

    # 4. Auto-start Services
    $log += "`n[+] Checking Auto-Start Services (non-Microsoft)..."
    Get-WmiObject -Class Win32_Service | Where-Object {
        $_.StartMode -eq "Auto" -and $_.State -eq "Running" -and $_.PathName -notlike "*Microsoft*"
    } | ForEach-Object {
        $log += "Service: $($_.Name) ($($_.DisplayName)) -> $($_.PathName)"
    }

    $log += "`n[DONE] Check Complete."

    # Write to user-defined file
    $log | Out-File -FilePath $LogPath -Encoding UTF8

    # Optional: Show output
    $log | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
}
